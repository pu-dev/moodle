define(["jquery","core/str","core/notification","core/loadingicon","core/modal_factory","mod_schedule/calendar_config","mod_schedule/urls","mod_schedule/http_response_code"],(function(e,o,n,t,s,r,d,a){function l(e){const o=new Date(0);return o.setUTCSeconds(e),o}function i(e){const o=l(e),n=new Intl.DateTimeFormat("en",{month:"long"}).format(o),t=new Intl.DateTimeFormat("en",{day:"2-digit"}).format(o),s=new Intl.DateTimeFormat("en",{hour:"2-digit",hour12:!1}).format(o),r=new Intl.DateTimeFormat("en",{minute:"2-digit",hour12:!1}).format(o);return`${s}:${1==r.length?"0"+r:r}, ${t}-${n}`}function c(e){let o=this;this.phpOpts=e,this.calendarEl=document.getElementById("calendar"),this.calendar=new FullCalendar.Calendar(this.calendarEl,{plugins:["interaction","dayGrid","timeGrid","list"],defaultView:"dayGridMonth",header:{left:"dayGridDay,dayGridWeek,dayGridMonth",center:"title",right:"prev,today,next "},displayEventTime:!0,displayEventEnd:!0,editable:!1,eventClick:function(e){o.lessonOnClick(e.event.extendedProps.lesson)},eventMouseEnter:function(e){o.lessonOnMouseEnter(e)},eventMouseLeave:function(e){o.lessonOnMouseLeave(e)},eventTimeFormat:{hour:"numeric",minute:"2-digit",meridiem:!1},dateClick:function(e){}})}return c.prototype.render=function(){this.calendar.render()},c.prototype.raw=function(){return this.calendar},c.prototype.addLesson=function(e){let o=l(e.date),n=l(e.end_date),t={id:e.lesson_id,title:e.teacher_name,start:o,end:n,editable:!0,startEditable:!0,durationEditable:!0,lesson:e};null!==e.student_id?(t.borderColor=r.bookedLessonBorderColor,t.backgroundColor=r.bookedLessonBackgroundColor):(t.borderColor=r.availableLessonBorderColor,t.backgroundColor=r.availableLessonBackgroundColor),this.calendar.addEvent(t)},c.prototype.addLessons=function(e){let o=Object.keys(e);for(let n of o)this.addLesson(e[n])},c.prototype.lessonOnClick=function(e){null===e.student_id?this.bookLesson(e):this.unbookLesson(e)},c.prototype.bookLesson=function(e){let o=this.getUrl(d.studentBookLesson);fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({lesson_id:e.lesson_id})}).then(e=>{if(!e.ok||e.status!=a.OK)throw"Error while booking class. Response status: "+e.status;return e.json()}).then(e=>{this.lessonBooked(e.data.lesson)}).catch((function(e){console.error(e)}))},c.prototype.lessonBooked=function(e){let o=this.calendar.getEventById(e.id),t=o.extendedProps.lesson;t.student_id=e.student_id,o.setProp("borderColor",r.bookedLessonBorderColor),o.setProp("backgroundColor",r.bookedLessonBackgroundColor),o.setExtendedProp("lesson",t);const s=i(e.date);n.alert("Lesson booked","Booked lesson on "+s,"OK")},c.prototype.unbookLesson=function(e){let o=this.getUrl(d.studentUnbookLesson);fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({lesson_id:e.lesson_id})}).then(e=>{if(!e.ok||e.status!=a.OK)throw"Error while unbooking class. Response status: "+e.status;return e.json()}).then(e=>{this.lessonUnbooked(e.data.lesson)}).catch((function(e){console.error(e)}))},c.prototype.lessonUnbooked=function(e){let o=this.calendar.getEventById(e.id),t=o.extendedProps.lesson;t.student_id=null,t.student_name=null,o.setProp("borderColor",r.availableLessonBorderColor),o.setProp("backgroundColor",r.availableLessonBackgroundColor),o.setExtendedProp("lesson",t);const s=i(e.date);n.alert("Lesson unbooked","Unbooked lesson on "+s,"OK")},c.prototype.loadAvailableLessons=function(){let o=this.getUrl(d.studentGetAvailableLessons),n=fetch(o).then(e=>e.json()).then(e=>{this.addLessons(e.data.lessons),this.render()}).catch((function(e){console.error(e)}));var s=e("#calendar");t.addIconToContainerRemoveOnCompletion(s,n)},c.prototype.lessonOnMouseEnter=function(e){},c.prototype.lessonOnMouseLeave=function(e){},c.prototype.getUrl=function(e,o){const n={id:this.phpOpts.cmid,sesskey:M.cfg.sesskey};let t=null;t="undefined"===o?n:{...n,...o};let s=new URL(e);return s.search=new URLSearchParams(t),s},c}));
